<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projects | Social Mobility Group</title>

  <link rel="icon" type="image/png" href="favicon.png?v=1" sizes="64x64">
  <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=B612+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    body {
      font-family: 'Cabin', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
    }
    .header-top {
      background-color: #e0f2ff;
      padding: 3px 20px;
      height: 180px;
      display: flex;
      align-items: center;
    }
    .site-navbar {
      background: #cceeff;
      padding: 0.8rem 0;
    }
    .site-navbar .nav-link {
      color: #003e5c;
      font-weight: 600;
      margin: 0 1rem;
    }
    .site-navbar .nav-link.active {
      text-decoration: underline;
      font-weight: 700;
    }

    /* map area */
    #map {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 20px;
    }
    #legend {
      background:white;
      padding:8px;
      border-radius:6px;
      border:1px solid #ccc;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header-top">
    <div class="container d-flex align-items-center">
      <a href="index.html">
        <img src="logo.png" alt="Logo" style="height:200px; margin-right:20px;">
      </a>
      <div class="site-logo">
        <span class="d-none d-md-inline" style="color:#0077b6; font-weight:normal;">
          <b style="font-size:1.4em;">So</b>cial <b style="font-size:1.4em;">Mo</b>bility<br>
          Research Group @ <b style="font-size:1.4em;">Kyungil</b> University
        </span>
        <span class="d-inline d-md-none" style="color:#0077b6; font-weight:bold;">
          @ <b style="font-size:1.4em;">Kyungil University</b>
        </span>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="site-navbar navbar navbar-expand-lg navbar-light">
    <div class="container">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="publications.html">Publication</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Group</a></li>
          <li class="nav-item"><a class="nav-link active" href="projects.html">Projects</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main style="max-width:1100px; margin:2rem auto; padding:0 1rem;">
    <h2><strong>Rail GIS Project</strong></h2>
    <p>Select an attribute to visualize Korean railway segments.</p>

    <label><b>Color by attribute:</b></label>
    <select id="attributeSelect">
      <option value="route_count">route_count</option>
      <option value="curvature_R">curvature_R</option>
      <option value="elev_mean">elev_mean</option>
      <option value="elev_max">elev_max</option>
      <option value="slope_pct">slope_pct</option>
    </select>

    <div id="map"></div>
  </main>

  <!-- FOOTER -->
  <footer class="footer text-center p-3" style="background:#e7f5ff;">
    <p class="mb-0">&copy; <span id="year"></span> Social Mobility Group. All rights reserved.</p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  let map = L.map('map', {
    zoomControl: true,
    minZoom: 7,
    maxZoom: 12,
  }).setView([36.5, 128], 8);

  /* ðŸ”¥ í•œêµ­ ì˜ì—­ìœ¼ë¡œ ê³ ì • (maxBounds) */
  var koreaBounds = [
    [33.0, 124.0],  // SW corner
    [39.5, 132.0]   // NE corner
  ];
  map.setMaxBounds(koreaBounds);
  map.on('drag', function () {
    map.panInsideBounds(koreaBounds, { animate: false });
  });

  /* ðŸ”¥ ë°°ê²½ ì§€ë„ íë¦¼ ì²˜ë¦¬ */
  let blurredTile = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    {
      maxZoom: 18,
      opacity: 1
    }
  );

  blurredTile.addTo(map);

  // CSS blur íš¨ê³¼ ì ìš©
  const tileObserver = new MutationObserver(() => {
    document.querySelectorAll(".leaflet-tile").forEach(tile => {
      tile.style.filter = "blur(1.8px) brightness(0.92)";
    });
  });
  tileObserver.observe(document.getElementById("map"), { childList: true, subtree: true });


  // GeoJSON íŒŒì¼ (GitHub Pages)
  const geojsonURL = "data/rail_links_entire.geojson";

  let layer;
  let geojsonData;

  /* ðŸ”¥ viridis-like ìƒ‰ìƒ */
  function viridisColor(value, min, max) {
    let t = (value - min) / (max - min + 1e-9);
    let r = Math.floor(68 + (253 - 68) * t);
    let g = Math.floor(1 + (231 - 1) * t);
    let b = Math.floor(84 + (37 - 84) * t);
    return `rgb(${r},${g},${b})`;
  }

  /* ðŸ”¥ ìŠ¤íƒ€ì¼ ìƒì„± (êµµê¸° ì¦ê°€ weight=5) */
  function styleByAttribute(attr) {
    let values = geojsonData.features
      .map(f => f.properties[attr])
      .filter(v => v !== null);

    let min = Math.min(...values);
    let max = Math.max(...values);

    return function (feature) {
      return {
        color: viridisColor(feature.properties[attr], min, max),
        weight: 5,
        opacity: 0.9
      };
    };
  }

  /* ðŸ”¥ ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
  function updateLayer(attr) {
    if (layer) map.removeLayer(layer);

    layer = L.geoJSON(geojsonData, {
      style: styleByAttribute(attr),
      onEachFeature: function (feature, layer) {
        layer.bindTooltip(`${attr}: ${feature.properties[attr]}`, {
          sticky: true
        });
      }
    }).addTo(map);
  }

  /* ðŸ”¥ GeoJSON ë¡œë“œ */
  fetch(geojsonURL)
    .then(res => res.json())
    .then(json => {
      geojsonData = json;
      updateLayer("curvature_R");
    });

  /* ðŸ”¥ attribute ì„ íƒ ì´ë²¤íŠ¸ */
  document.getElementById("attrSelect").addEventListener("change", e => {
    updateLayer(e.target.value);
  });
</script>
