<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projects | Social Mobility Group</title>

  <link rel="icon" type="image/png" href="favicon.png?v=1" sizes="64x64">
  <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=B612+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- viridis colormap -->
  <script src="https://cdn.jsdelivr.net/npm/colormap@2.3.2/colormap.min.js"></script>

  <style>
    body { background:#f8f9fa; font-family:'Cabin',sans-serif; }

    #map {
      height: 650px;
      border: 2px solid #ccc;
      border-radius: 8px;
      margin: 20px auto;
      filter: blur(0.8px); /* 흐림 */
    }

    .attr-box {
      max-width: 1100px;
      margin: 1.5rem auto 0;
      padding: 0 1rem;
      text-align: right;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header-top">
    <div class="container d-flex align-items-center">
      <a href="index.html">
        <img src="logo.png" style="height:200px; margin-right:20px;">
      </a>
      <div class="site-logo">
        <b style="font-size:1.4em;">So</b>cial <b style="font-size:1.4em;">Mo</b>bility<br>
        Research Group @ <b style="font-size:1.4em;">Kyungil</b> University
      </div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="site-navbar navbar navbar-expand-lg navbar-light">
    <div class="container">
      <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="publications.html">Publication</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Group</a></li>
          <li class="nav-item"><a class="nav-link active" href="projects.html">Projects</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Attribute 선택 -->
  <div class="attr-box">
    <label><strong>Attribute:</strong></label>
    <select id="attrSel" class="form-control" style="width:200px; display:inline-block;">
      <option value="route_count">route_count</option>
      <option value="curvature_R">curvature_R</option>
      <option value="elev_mean">elev_mean</option>
      <option value="elev_max">elev_max</option>
      <option value="slope_pct">slope_pct</option>
    </select>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <footer class="footer text-center p-3" style="background:#e7f5ff;">
    <p>&copy; <span id="year"></span> Social Mobility Group.</p>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    //----------------------------------------------------------------------
    // 지도 초기화 (대한민국 중심)
    //----------------------------------------------------------------------
    var map = L.map('map').setView([36.3, 128], 8);
    map.setMaxBounds([[33,124],[39.5,132]]);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(map);

    //----------------------------------------------------------------------
    // viridis 색상 매핑 (정규화 없이 값 자체 기반)
    //----------------------------------------------------------------------
    function viridisByValue(v) {
      const cmap = colormap({ colormap:"viridis", nshades:256, format:"hex" });
      let idx = Math.floor((v * 37) % 256);
      if (idx < 0) idx = -idx;
      return cmap[idx];
    }

    var geojsonLayer;
    var geojsonData;

    //----------------------------------------------------------------------
    // GeoJSON 불러오기
    //----------------------------------------------------------------------
    fetch("projects/rail_all.geojson")
      .then(r => r.json())
      .then(data => {
        geojsonData = data;
        updateMap("route_count");
      });

    //----------------------------------------------------------------------
    // 지도 업데이트
    //----------------------------------------------------------------------
    function updateMap(attr) {

      if (geojsonLayer) geojsonLayer.remove();

      geojsonLayer = L.geoJSON(geojsonData, {
        style: f => ({
          color: viridisByValue(f.properties[attr]),
          weight: 4,
          opacity: 1.0
        }),

        onEachFeature: (feature, layer) => {
          layer.bindTooltip(
            `<b>${attr}</b>: ${feature.properties[attr]}`,
            { sticky: true }
          );
        }
      }).addTo(map);
    }

    //----------------------------------------------------------------------
    // dropdown 이벤트
    //----------------------------------------------------------------------
    document.getElementById("attrSel").addEventListener("change", function(){
      updateMap(this.value);
    });

  </script>

</body>
</html>
